<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QML Pipeline (Sprint-1)</title>

  <!-- Your stylesheet is still loaded; we also add a few inline rules below -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="sysml-styles.css" />

  <style>
    :root { --ink:#111; --card:#fff; --line:#e5e7eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 0 12px; }
    .panel { margin-top: 8px; }
    .toolbar .btn { margin-right: 6px; margin-bottom: 6px; }
    .btn { padding: 6px 10px; border: 1px solid #cbd5e1; background:#fff; border-radius: 6px; cursor: pointer; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .note { color:#64748b; }
    .muted { color:#64748b; }

    /* Built-in canvas (no Drawflow) */
    .studio { display:flex; gap:14px; align-items:flex-start; }
    #canvas {
      width: calc(100% - 360px);
      height: 72vh; min-height: 520px;
      background:#fafafa; border:1px solid #ddd; border-radius:10px;
      position: relative; overflow: auto;
    }
    #sidepanel{
      width:340px; min-width:340px; background:var(--card);
      border:1px solid var(--line); border-radius:10px;
      padding:10px; color:var(--ink); height:72vh; overflow:auto;
    }

    /* Nodes */
    .node {
      position:absolute; min-width: 160px; max-width: 260px;
      background:#fff; border:1px solid #d1d5db; border-radius:8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
      padding:8px; cursor:grab; user-select:none;
    }
    .node:active { cursor:grabbing; }
    .node .node-title { font-weight:600; margin-bottom:6px; }
    .node .node-param { display:block; margin:6px 0; }
    .node .node-param input { width:100%; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px; }
    .node.selected { outline: 2px solid #3b82f6; }

    /* Wiring */
    #wires {
      position: absolute; inset: 0;
      pointer-events: none; /* wires don't block clicks */
      z-index: 1;
    }
    .node {
      z-index: 2;
      position: relative;
    }
    .node .ports {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
      padding: 4px 0;
    }
    .node .port {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block; vertical-align: middle;
      box-shadow: 0 0 0 2px #fff, 0 0 0 3px #666;
      cursor: crosshair;
      position: relative;
      z-index: 3;
    }
    .node .port:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 2px #fff, 0 0 0 3px #333;
    }
    .node .port.in  { background: #10b981; }  /* green */
    .node .port.out { background: #3b82f6; }  /* blue  */
    
    /* Wire animation */
    @keyframes dash {
      from { stroke-dashoffset: 15; }
      to { stroke-dashoffset: 0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QML DataFlow Studio</h1>

    <div class="panel">
      <div class="toolbar">
        <button type="button" class="btn" id="add-dataset">Add Dataset</button>
        <button type="button" class="btn" id="add-encoder">Add Encoder</button>
        <button type="button" class="btn" id="add-circuit">Add Circuit</button>
        <button type="button" class="btn" id="add-optimizer">Add Optimizer</button>
        <button type="button" class="btn" id="add-output">Add Output</button>
        <button type="button" class="btn" id="btn-export-model">Export Model JSON</button>
        <button type="button" class="btn" id="btn-load-model">Load Model JSON</button>
        <button type="button" class="btn" id="btn-generate-from-model">Generate From Model</button>
        <button type="button" class="btn" id="btn-toggle-sysml">SysML Block View</button>
      </div>

      <div class="studio">
        <!-- SysML Block Diagram View -->
        <div id="sysml-view" class="sysml-diagram" style="display: none;">
          <div class="sysml-title">QML Pipeline - SysML Block Diagram</div>
          <div class="sysml-layout sysml-layout-horizontal">
            <div class="sysml-block" data-type="datablock" id="sysml-datablock">
              <div class="sysml-stereotype">«block»</div>
              <div class="sysml-block-header">DataBlock</div>
              <div class="sysml-properties">
                <div class="sysml-property">dataset_type: iris</div>
                <div class="sysml-property">test_size: 0.2</div>
                <div class="sysml-property">seed: 42</div>
              </div>
              <div class="sysml-flow sysml-flow-horizontal">
                <div class="sysml-flow-arrow"></div>
                <div class="sysml-flow-label">ProcessedData</div>
              </div>
            </div>

            <div class="sysml-block" data-type="encoderblock" id="sysml-encoderblock">
              <div class="sysml-stereotype">«block»</div>
              <div class="sysml-block-header">EncoderBlock</div>
              <div class="sysml-properties">
                <div class="sysml-property">encoding_type: angle</div>
                <div class="sysml-property">n_qubits: 4</div>
              </div>
              <div class="sysml-flow sysml-flow-horizontal">
                <div class="sysml-flow-arrow"></div>
                <div class="sysml-flow-label">EncodedData</div>
              </div>
            </div>

            <div class="sysml-block" data-type="circuitblock" id="sysml-circuitblock">
              <div class="sysml-stereotype">«block»</div>
              <div class="sysml-block-header">CircuitBlock</div>
              <div class="sysml-properties">
                <div class="sysml-property">ansatz_type: ry</div>
                <div class="sysml-property">num_layers: 2</div>
              </div>
              <div class="sysml-flow sysml-flow-horizontal">
                <div class="sysml-flow-arrow"></div>
                <div class="sysml-flow-label">QuantumFeatures</div>
              </div>
            </div>

            <div class="sysml-block" data-type="optimizerblock" id="sysml-optimizerblock">
              <div class="sysml-stereotype">«block»</div>
              <div class="sysml-block-header">OptimizerBlock</div>
              <div class="sysml-properties">
                <div class="sysml-property">optimizer_type: cobyla</div>
                <div class="sysml-property">max_iterations: 100</div>
              </div>
              <div class="sysml-flow sysml-flow-horizontal">
                <div class="sysml-flow-arrow"></div>
                <div class="sysml-flow-label">TrainedModel</div>
              </div>
            </div>

            <div class="sysml-block" data-type="outputblock" id="sysml-outputblock">
              <div class="sysml-stereotype">«block»</div>
              <div class="sysml-block-header">OutputBlock</div>
              <div class="sysml-properties">
                <div class="sysml-property">return_predictions: true</div>
                <div class="sysml-property">metrics: accuracy</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Canvas View -->
        <div id="canvas" aria-label="Model canvas">
          <svg id="wires"></svg>
        </div>

        <div id="sidepanel" aria-label="Node editor">
          <h3>Node editor</h3>
          <div id="selected-info" class="muted">No node selected. Click a node or add one.</div>
          <div id="node-params" style="margin-top:8px;"></div>
          <div style="margin-top:10px">
            <button type="button" class="btn" id="btn-save-node">Save Node</button>
            <button type="button" class="btn" id="btn-delete-node">Delete Node</button>
          </div>

          <hr style="margin:12px 0" />
          <h4>Persistence</h4>
          <input type="file" id="file-load-model" accept=".json" style="display:none" />
          <button type="button" class="btn" id="btn-save-model">Download Model</button>
          <button type="button" class="btn" id="btn-load-model-ui">Upload Model</button>

          <hr style="margin:12px 0" />
          <h3>Block Info</h3>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
            <button type="button" class="btn" data-info="dataset">Dataset</button>
            <button type="button" class="btn" data-info="encoder">Encoder</button>
            <button type="button" class="btn" data-info="circuit">Circuit</button>
            <button type="button" class="btn" data-info="optimizer">Optimizer</button>
            <button type="button" class="btn" data-info="output">Training & Output</button>
          </div>
          <div id="info-text" class="note"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Dataset Selection (SysML Blocks)</h3>
        <div style="margin-bottom: 10px;">
          <button type="button" class="btn" id="btn-diabetes">Use Diabetes Dataset</button>
          <button type="button" class="btn" id="btn-iris">Use Iris Dataset (Binary)</button>
          <button type="button" class="btn" id="btn-realestate">Use Real Estate Dataset</button>
          <button type="button" class="btn" id="btn-mnist">Use MNIST Subset (0 vs 1)</button>
        </div>
        
        <h3>Actions</h3>
        <input type="file" id="csvFile" accept=".csv" style="display: none;" />
        <button type="button" class="btn" id="btn-upload" style="display: none;">Upload CSV</button>
        <button type="button" class="btn" id="btn-load-sample" style="display: none;">Load Iris Sample</button>

        <select id="select-encoding">
          <option value="angle">Angle Encoding</option>
          <option value="basis">Basis Encoding</option>
        </select>
        <select id="select-ansatz">
          <option value="ry">RY Layer</option>
          <option value="realamplitudes">RealAmplitudes</option>
        </select>
        <input id="input-layers" type="number" min="1" max="6" step="1" value="2" style="width:60px" />
        <button type="button" class="btn" id="btn-generate">Generate Qiskit Code</button>
        <button type="button" class="btn" id="btn-export">Export JSON</button>
        <button type="button" class="btn primary" id="btn-run">Run Pipeline</button>
      </div>

      <div id="msg" class="note" style="margin-top:4px;"></div>
      <pre id="result" aria-live="polite"></pre>

      <h3>Generated Code Template</h3>
      <pre id="codePreview" style="background:#111;color:#cfc;padding:8px;overflow:auto;height:260px;"></pre>
      <div style="margin-top:8px"><button type="button" class="btn" id="btn-download-code">Download Code (py)</button></div>
    </div>
  </div>

  <!-- No external Drawflow any more -->
  <script src="app.js" defer></script>
</body>
</html>